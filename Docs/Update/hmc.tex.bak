\subsection{\label{hmc}\index{hmc}HMC}

HMC is abbreviation for hybrid Monte Carlo.

\subsubsection{\label{hmc_scheme}The fermion action}

Cooperating with HMC, the fermion is usually the \index{pseudofermions}'Pseudofermions`.

We begin with Eq.~(1.85) and Eq.~(1.86) of Ref.~\cite{latticeqcdbook2017}.
\begin{equation}
\begin{split}
&Z=\int \mathcal{D}[U] \prod _{f=1}^{N_f} \mathcal {D}[\bar{\psi}_f]\mathcal {D}[\psi _f]\exp \left(-S_G[U]+\sum _{f=1}^{N_f}\bar{\psi} _f\left(\hat{D}_f\right)\psi _f\right)
\end{split}
\end{equation}
where $\hat{D}_f=D+m_f$.

It can be evaluated as Eq.~(1.86) of Ref.~\cite{latticeqcdbook2017}~(or Eq.~(4.19) of Ref.~\cite{condensedmatterbookAltland})
\begin{equation}
\begin{split}
&Z=\prod _{f=1}^{N_f} \det \left(\hat{D}_f\right)\int \mathcal{D}[U] \exp \left(-S_G[U]\right)
\end{split}
\end{equation}

On the other hand, with the help of Gaussian integral of complex vectors Eq.~(3.17) of Ref.~\cite{condensedmatterbookAltland}
\begin{equation}
\begin{split}
&\int d{\bf v}^{\dagger}d{\bf v} \exp (-{\bf v}^{\dagger} {\bf A} {\bf v})=\pi ^N \left(\det {\bf A}\right)^{-1}
\end{split}
\end{equation}
which is (3.31) of Ref.~\cite{latticeqcdbook2017}
\begin{equation}
\begin{split}
&\frac{1}{ \det ({\bf A}) }=\int \mathcal{D}[\eta] \exp (-\eta^{\dagger} {\bf A} \eta)
\end{split}
\end{equation}
where $\eta$ now is a complex Bosonic field, and the normalization
\begin{equation}
\begin{split}
&\mathcal{D}[\eta] = \prod \frac{d{\rm Re}(\eta _i)d{\rm Im}(\eta _i)}{\pi},\;\;1=\int \mathcal{D}[\eta] \exp (-\eta^{\dagger} \eta)
\end{split}
\end{equation}
is assumed. With condition $\lambda ({\bf M})$ denoted as eigen-values of ${\bf M}$
\begin{equation}
\begin{split}
&\lambda ({\bf A}+{\bf A}^{\dagger}) > 0.
\end{split}
\end{equation}

We now, concentrate on two degenerate fermion flavours. i.e. considering
\begin{equation}
\begin{split}
&S_F=-\bar{\psi}_u \hat{D} \psi _u-\bar{\psi}_d \hat{D} \psi _d.
\end{split}
\end{equation}

Using $\det (DD^{\dagger})=\det (D)\det (D^{\dagger})$ and $\det(M^{-1})=\left(\det (M)\right)^{-1}$ and \textcolor[rgb]{1,0,0}{$\det (D)=\det (D^{\dagger})$} (It is mentioned in Ref.~\cite{weingarten1981}, however, I have not prove it yet. But for Wilson Fermions or any $\gamma _5$-hermiticity fermions, $\hat{D}^{\dagger}=\gamma _5 D \gamma _5 + m=\gamma _5 (D+m) \gamma _5=\gamma _5 \hat{D} \gamma _5$, and $\det(\hat{D}^{\dagger})=\det(\gamma _5)\det(\hat{D})\det(\gamma _5)=\det (\hat{D})$.), one can show Eq.~(8.9) of Ref.~\cite{latticeqcdbook2010}
\begin{equation}
\begin{split}
&\int \mathcal{D}[\bar{\psi}]\mathcal{D}[\psi]\exp\left(-\bar{\psi}_u \hat{D} \psi _u-\bar{\psi}_d \hat{D} \psi _d\right)=\det (\hat{D}\hat{D}^{\dagger})=\int \mathcal{D}[\phi] \exp (-\phi ^{\dagger}\left(\hat{D}\hat{D}^{\dagger}\right)^{-1} \phi)
\end{split}
\end{equation}
where $\phi$ now is a complex Bosnic field.

So, generally, we are using HMC to evaluate the action with 'Pseudofermions`, or in other words, we are working with an action including only gauge and bosons.
\begin{equation}
\begin{split}
&S=S_G+S_{pf}=S_G-\phi ^{\dagger}\left(\hat{D}\hat{D}^{\dagger}\right)^{-1} \phi\\
\end{split}
\end{equation}
where $pf$ is short for pseudofermion.

\subsubsection{\label{hmc_scheme}Basic idea, force from gauge field}

The basic idea is to use a \index{molecular dynamics}molecular dynamics simulation. In other words, it is a integration of \index{Langevin equation}Langevin equation.

Treating $SU(N)$ matrix $U$ on links as coordinate, HMC will generate a pair of configurations, $(P,U)$, where $P$ is momentum and $P\in \mathfrak{su}(N)$.

One can:

(1) Create a random $P$.

(2) Obtain $\dot{P}$, $\dot{U}$. Note that, dot is $d/d\tau$, where $\tau$ is `Markov time'.

(3) Numerically evaluate the differential equation, and use a Metropolis accept / reject to update.

\begin{itemize}
\item \index{force}Force
\end{itemize}

Defined by Newton, $dp/dt$ is a force, so in CLG, $\dot{P}$ is called `force'. See Eqs.~(2.53), (2.56) and (2.57) of Ref.~\cite{latticeqcdbook2017}, for $SU(N)$,
\begin{equation}
\begin{split}
&F_{\mu}(x)=\dot{P}_{\mu}(x)=-\frac{\beta}{2N}\{U_{\mu}(x)\Sigma _{\mu}(x)\}_{TA}\\
&\{W\}_{TA}=\frac{W-W^{\dagger}}{2}-{\rm tr}\left(\frac{W-W^{\dagger}}{2N}\right){\bf I}\\
\end{split}
\label{eq.hmc.force}
\end{equation}
where ${\bf I}$ is identity matrix, $\Sigma$ is the `Staple'.

\begin{itemize}
\item \index{Integrator}Integrator
\end{itemize}

Knowing $\dot{P}$, and $\dot {U}$, to obtain $U$ and $P$ is simply
\begin{equation}
\begin{split}
&U(\tau+d\tau)\approx \dot{U}d\tau + U(\tau),\;\;P(\tau+d\tau)\approx \dot{P}d\tau + P(\tau)\\
\end{split}
\end{equation}

A more accurate calculation is done by integrator, for example, the leap frog integrator, the $M$ step leap frog integral is described in Ref.~\cite{latticeqcdbook2010},
\begin{subequations}
\begin{eqnarray}
&\epsilon = \frac{\tau}{M}\\
&U_{\mu}(x,(n+1)\epsilon)=U_{\mu}(x,n\epsilon)+\epsilon P_{\mu}(x,n\epsilon)+\frac{1}{2}F_{\mu}(x,n\epsilon)\epsilon ^2\\
&P_{\mu}(x,(n+1)\epsilon)=P_{\mu}(x,n\epsilon)+\frac{1}{2}\left(F_{\mu}(x,(n+1)\epsilon)+F_{\mu}(x,n\epsilon)\right)\epsilon
\end{eqnarray}
\label{eq.hmc.update_basic}
\end{subequations}

So, knowing $U(n\epsilon)$ we can calculate $F(n\epsilon)$ using Eq.~(\ref{eq.hmc.force}).
Knowing $U(n\epsilon),P(n\epsilon),F(n\epsilon)$, we can calculate $U((n+1)\epsilon)$ using Eq.~(\ref{eq.hmc.update_basic}).b.
Then we are able to calculate $F((n+1)\epsilon)$ again using Eq.~(\ref{eq.hmc.force}).
Then we can calculate $P((n+1)\epsilon)$ using Eq.~(\ref{eq.hmc.update_basic}).c.

\begin{itemize}
  \item About the randomized $P$
\end{itemize}

The randomized $P$ is chosen according to normal distribution $\exp \left(-<P,P>/2\right)$. Using $P=\sum \omega _i T^i$, $tr((T^i)\cdot (T^j))=2\delta _{ij}$. It is usually written as distribution $\exp \left(-tr(P^2)\right)$. One can randomize $\omega _i$ using $\exp \left(-\omega_i^*\omega_i\right)$. Then using $P=\sum \omega _i T^i$.

\subsubsection{\label{forceOfPseudofermions}Force of pseudofermions}

For important sampling, one can generate both $U$ and $\phi$ by $e^{-S}$. In molecular dynamics simulation, it can be simplified as:

(1) Evaluate $U$ use force of $U$ and $\phi$ on $U$.

(1) Evaluate $\phi$ use force of $U$ and $\phi$ on $\phi$.

The second step can be simplified as, generating random complex numbers $\phi$ according to $\exp (-\phi^{\dagger} \left(\hat{D}\hat{D}^{\dagger}\right)^{-1}\phi)=\exp (-\phi^{\dagger}(\hat{D}^{\dagger})^{-1} \hat{D}^{-1}\phi)$. Where $D$ is a function of $U$.

Let $\chi$ be random complex numbers according to $\exp (-\chi ^{\dagger}\chi)$. Let $(D)^{-1}\phi=\chi$, $\phi$ is the random number satisfying distribution we want. And $\phi = D\chi$.

Using the Wilson Fermion action in Eq.~() of Ref.{}.
\begin{equation}
\begin{split}
&\hat{D}=D+1\\
&D=-\kappa\sum _{\mu}\left((1-\gamma _{\mu})U_{\mu}(x)\delta _{x,x+\mu}+(1+\gamma _{\mu})U_{\mu}^{-1}(x-\mu)\delta _{x,x-\mu}\right)\\
\end{split}
\end{equation}
with $\kappa=1/(2am_f+8)$.

The force of $\phi$ on $U$ is obtained as $\partial _{U_{\mu}}S_{pf}$. The result for Wilson Fermion action is shown in Eqs.~(8.39), (8.44) and (8.45) of Ref.~\cite{latticeqcdbook2010} as
\begin{equation}
\begin{split}
&F=F_G+\sum _i T^i \nabla ^i \left(\phi ^{\dagger}\left(\hat{D}\hat{D}^{\dagger}\right)^{-1}\phi\right).\\
&\nabla ^i \left(\phi ^{\dagger}\left(\hat{D}\hat{D}^{\dagger}\right)^{-1}\phi\right) = -\left(\left(\hat{D}\hat{D}^{\dagger}\right)^{-1}\phi\right)^{\dagger}\left(\frac{\partial D}{\partial \omega _{\mu}^i}\hat{D}^{\dagger}+\hat{D}\frac{\partial D^{\dagger}}{\partial \omega _{\mu}^i}\right)\left(\left(\hat{D}\hat{D}^{\dagger}\right)^{-1}\phi\right).\\
&\frac{\partial \hat{D}}{\partial {\omega _{\mu}^i}}=\frac{\partial D}{\partial {\omega _{\mu}^i}}=-i\kappa \left\{(1-\gamma _{\mu})T^iU_{\mu}(x)\delta _{x,x+\mu}-(1+\gamma _{\mu})U_{\mu}^{-1}(x-\mu)T^i\delta _{x,x-\mu} \right\} \\
&\hat{D}^{\dagger} = \gamma _5 \hat{D} \gamma _5, \;\;\frac{\partial D^{\dagger}}{\partial \omega _{\mu}^i}=\gamma _5 \frac{\partial D}{\partial \omega _{\mu}^i} \gamma _5\\
\end{split}
\end{equation}
where $F_G$ is force from $U$ introduced in Sec.~\ref{hmc_scheme}, $T^i$ are $SU(3)$ generators. And
\begin{equation}
\begin{split}
&U_{\mu}=\exp (i\sum _i \omega _{\mu}^i T^i),\;\;\frac{\partial U_{\mu}}{\partial \omega_{\mu}^i}=iT^iU_{\mu},\;\;\frac{\partial U^{\dagger}_{\mu}}{\partial \omega_{\mu}^i}=-iU^{\dagger}_{\mu}T^i,\;\;\left(T^i\right)^{\dagger}=T^i.\\
\end{split}
\end{equation}
is used.

We can simplify it further by $\left(\hat{D}^{\dagger}(\hat{D}\hat{D}^{\dagger})^{-1}\phi\right)^{\dagger}=\left((\hat{D}\hat{D}^{\dagger})^{-1}\phi\right)^{\dagger}\hat{D}^{\dagger}$, so
\begin{equation}
\begin{split}
&\phi _1=\left(\left(\hat{D}\hat{D}^{\dagger}\right)^{-1}\phi\right),\;\;
 \phi _2=\hat{D}^{\dagger}\left(\left(\hat{D}\hat{D}^{\dagger}\right)^{-1}\phi\right),\;\;\phi _1^{\dagger}D=\phi _2^{\dagger}\\
&\left(\left(\hat{D}\hat{D}^{\dagger}\right)^{-1}\phi\right)^{\dagger}\left(\frac{\partial D}{\partial \omega _{\mu}^i}\hat{D}^{\dagger}+\hat{D}\frac{\partial D^{\dagger}}{\partial \omega _{\mu}^i}\right)\left(\left(\hat{D}\hat{D}^{\dagger}\right)^{-1}\phi\right)\\
&=\phi _1^{\dagger} \frac{\partial D}{\partial \omega _{\mu}^i} \phi _2+\phi _2^{\dagger} \frac{\partial D^{\dagger}}{\partial \omega _{\mu}^i} \phi _1=2{\rm Re}\left(\phi _1 ^{\dagger} \frac{\partial D}{\partial \omega _{\mu}^i} \phi _2\right)\\
\end{split}
\end{equation}

So we can calculate $\phi _1$ first, then $\phi _2 = \hat{D}^{\dagger}\phi _1$. Then contract the spinor and color space with $\partial D / \partial \omega$.

Note that, it seems we do not need $\phi$ but just $\chi$, because $\phi _1=(\hat{D}^{\dagger})^{-1}\hat{D}^{-1}\phi=(\hat{D}^{\dagger})^{-1}\chi$ and $\phi _2=\chi$. However, this is \textcolor[rgb]{1,0,0}{\textbf{incorrect}} because $D$ is changing when integrating the Langevin equation.

The last part is how to calculate $(\hat{D}\hat{D}^{\dagger})^{-1}$.

\subsubsection{\label{Leap frog}\index{leap frog}Leap frog integrator}

\subsubsection{\label{Leap frog}\index{leap frog}Leap frog integrator}

In Sec.~\ref{hmc_scheme}, the basic idea is introduced. However, the implementation is slightly different.
\begin{subequations}
\begin{eqnarray}
&U_{\mu}(0,x)=gauge(x),\;\;P_{\mu}(0,x)=i\sum _{a}r_a(\mu,x)T_a\\
&F_{\mu}(n\epsilon,x)=-\frac{\beta}{2N}\{U_{\mu}(n\epsilon,x)\Sigma _{\mu}(n\epsilon,x)\}_{TA}\\
&P_{\mu}(\frac{1}{2}\epsilon,x)=P_{\mu}(0,x)+\frac{\epsilon}{2}F_{\mu}(0,x)\\
&U_{\mu}((n+1)\epsilon,x)=\exp \left(\epsilon P_{\mu}((n+\frac{1}{2})\epsilon,x)\right)U_{\mu}(n\epsilon,x)\\
&P_{\mu}((n+\frac{1}{2})\epsilon,x)=P_{\mu}((n-\frac{1}{2})\epsilon,x)+\epsilon F_{\mu}(n\epsilon,x)
\end{eqnarray}
\label{eq.hmc.update_leapfrog}
\end{subequations}
or simply written as
\begin{equation}
\begin{split}
&P_{\epsilon}\circ U_{\epsilon}\circ P_{\frac{1}{2}\epsilon}\left(P_0,U_0\right)
\end{split}
\label{eq.hmc.update_leapfrog2}
\end{equation}
The pseudo code can be written as

\begin{lstlisting}

FieldGauge field = gaugeField.copy();

//sum _i i r_i T_i, where r_i are random numbers generated by Gaussian distribution
FieldGauge momentumField = FieldGauge::RandomGenerator();

//First half update
FieldGauge forceField = FieldGauge::Zero();
for (int i = 0; i < m_lstActions.Num(); ++i)
{
    forceField += m_lstActions[i]->CalculateForceOnGauge(field);
}
//momentumField = momentumField + 0.5f * epsilon * forceField
momentumField.Axpy(fStep * 0.5f, forceField);

for (int i = 1; i < steps + 1; ++i)
{
    field = FieldGauge::Exp(fStep * momentumField) * field;
    forceField = FieldGauge::Zero();
    for (int j = 0; j < m_lstActions.Num(); ++j)
    {
        forceField += m_lstActions[j]->CalculateForceOnGauge(field);
    }
    momentumField.Axpy((j < steps) ? fStep : (fStep * 0.5f), forceField);
}

\end{lstlisting}

\subsubsection{\label{Omelyan}\index{Omelyan}Omelyan integrator}

The Omelyan integrator can be simply written as (c.f. Eq.~(2.80) of Ref.~\cite{latticeqcdbook2017})
\begin{equation}
\begin{split}
&P_{\lambda\epsilon}\circ U_{\frac{1}{2}\epsilon}\circ P_{(1-2\lambda)\epsilon}\circ U_{\frac{1}{2}\epsilon}\circ P_{\lambda\epsilon}\left(P_0,U_0\right)
\end{split}
\label{eq.hmc.update_Omelyan}
\end{equation}
with
\begin{equation}
\begin{split}
&\lambda = \frac{1}{2}-\frac{\left(2\sqrt{326}+36\right)^{\frac{1}{3}}}{12}+\frac{1}{6\left(2\sqrt{326}+36\right)^{\frac{1}{3}}}\approx 0.19318332750378364
\end{split}
\label{eq.hmc.update_Omelyan2}
\end{equation}

\subsubsection{\label{summaryOfHMC}HMC with pseudofermions}

We follow from Sec.8.2.3 in Ref.~\cite{latticeqcdbook2010}. The HMC with fermions can be divided into 6 steps.

\begin{enumerate}
  \item Generate a complex Bosonic field with $\chi \sim \exp (-\chi ^{\dagger}\chi)$, and $\phi = \hat{D} \chi$.
  \item Generate a momentum field $P$ by $\exp (-tr(P^2))$.
  \item Calculate $E=tr(P^2)+S_G(U)+S_{pf}(U,\phi)$.
  \item Use $U_0$ to calculate $F$, evaluate $P$ and $U$ using integrator. Here, $\phi$ is treated as a constant field.
  \item Finally, use $P',U'$ to calculate Calculate $E'=tr({P'}^2)+S_G(U')+S_{pf}(U',\phi)$. Use a Metropolis to accept or reject the result.
\end{enumerate}




